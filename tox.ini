[tox]
minversion = 3.3.0
envlist = py37, py38, py39, py310
isolated_build = True
requires = setuptools >= 36.2.0

[gh-actions]
python =
    3.7: py37
    3.8: py38
    3.9: py39
    3.10: py310

[testenv]
allowlist_externals =
    mkdir
deps =
    apache-airflow>=2.0.0
    markupsafe>=2.0.1
    pytest
    requests_mock
setenv =
    AIRFLOW_HOME = tests/airflow_home
    AIRFLOW__CORE__UNIT_TEST_MODE = True
    AIRFLOW_TEST_CONFIG = tests/test.cfg
commands =
    mkdir -p tests/airflow_home/
    airflow db init
    pytest

# For Python 3.8 we additionally collect test coverage
# infromation and upload it to codecov
[testenv:py38]
allowlist_externals =
    mkdir
deps =
    {[testenv]deps}
    toloka-kit
    coverage
    codecov
passenv =
    CI
    CODECOV_*
setenv =
    AIRFLOW_HOME = tests/airflow_home
    AIRFLOW__CORE__UNIT_TEST_MODE = True
    AIRFLOW_TEST_CONFIG = tests/test.cfg
commands =
    mkdir -p tests/airflow_home/
    airflow db init
    coverage run --source toloka_provider -m pytest
    codecov

[testenv:release]
basepython = python3.8
deps =
    build
    twine
passenv =
    TWINE_USERNAME
    TWINE_PASSWORD
commands =
    python -m build --sdist --wheel .
    twine upload dist/*
